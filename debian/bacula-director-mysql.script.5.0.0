#!/bin/sh

# This script exists to remove the JobMedia column in Bacula 5.0.0.
# It can be removed from the tree after upgrades to 5.0.0 are no longer
# a concern.
#
# More details are at
# http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=569285
# http://bugs.bacula.org/view.php?id=1498
#
# Quoting the latter, with summary by John Goerzen:
#
# In Bacula 5.0.0, src/cats/update_mysql_tables.in contains this line:
# 
# ALTER TABLE JobMedia DROP Stripe ;
# 
# And indeed, in Bacula 3.0.0, src/cats/make_mysql_tables.in created
# that column. Trouble is:
#
# bacula/updatedb$ grep -i stripe *mysql*
# update_mysql_tables_8_to_9:ALTER TABLE JobMedia ADD COLUMN Stripe
# INTEGER UNSIGNED NOT NULL DEFAULT 0;
# update_mysql_tables_9_to_10.in:ALTER TABLE JobMedia DROP COLUMN
# Stripe;
#
# In other words, users that were running Bacula 1.38, and upgraded to
# 2.0, would have had the Stripe column removed at that point and never
# re-created. It seems like somebody added the code to remove the
# stripe column to 2.0 but forgot to remove it from the
# make_mysql_tables.in until 5.0.

. /etc/dbconfig-common/bacula-director-mysql.conf

mysqlcmd () {
    MYSQLUSER=""
    MYSQLPASS=""
    MYSQLSERVER=""
    if [ -n "$dbc_dbuser" ]; 
        then MYSQLUSER="--user=$dbc_dbuser"
    fi

    if [ -n "$dbc_dbpass" ];
        then MYSQLPASS="--password=$dbc_dbpass"
    fi

    if [ -n "$dbc_dbserver" ];
        then MYSQLSERVER="--host=$dbc_dbserver"
    fi

    if [ -n "$dbc_dbport" ];
        then MYSQLPORT="$MYSQL --port=$dbc_dbport"
    fi

    mysql "$MYSQLUSER" "$MYSQLPASS" "$MYSQLSERVER" "$MYSQLPORT" "$@" "$dbc_dbname"
}

if echo "DESCRIBE JobMedia;" | mysqlcmd | grep -q -i Stripe; then
    echo "Found column Stripe in JobMedia; removing."
    echo "ALTER TABLE JobMedia DROP Stripe;" | mysqlcmd
else
    echo "Did not find column Stripe in JobMedia; not attempting to remove it."
fi
