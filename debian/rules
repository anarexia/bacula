#!/usr/bin/make -f

#export DH_VERBOSE=1

DEB_HOST_ARCH_OS    ?= $(shell dpkg-architecture -qDEB_HOST_ARCH_OS)

VARIANTS := sqlite3 pgsql mysql

######################################################################

BUILDDIR := $(CURDIR)/debian/tmp-build
INSTALLDIR := $(CURDIR)/debian/tmp-install
DBC := usr/share/dbconfig-common/data/

CONF_ALL	= --enable-smartalloc \
	--with-python --with-tcp-wrappers \
	--with-openssl \
	--with-libiconv-prefix=/usr/include --with-readline=/usr/include/readline \
	--disable-conio \
	--with-libintl-prefix=/usr/include --with-x \
		--docdir=\$${prefix}/share/doc/bacula-common \
		--htmldir=\$${prefix}/share/doc/bacula-common/html \
		--libdir=\$${prefix}/lib/bacula \
	--enable-batch-insert \
	--disable-bwx-console \
	--without-qwt \
	--enable-ipv6 \
	--with-dir-passowrd=XXX_DIRPASSWORD_XXX \
	--with-fd-password=XXX_FDPASSWORD_XXX \
	--with-sd-password=XXX_SDPASSWORD_XXX \
	--with-mon-dir-password=XXX_MONDIRPASSWORD_XXX \
	--with-mon-fd-password=XXX_MONFDPASSWORD_XXX \
	--with-mon-sd-password=XXX_MONSDPASSWORD_XXX \
	--with-db-name=XXX_DBNAME_XXX \
	--with-db-user=XXX_DBUSER_XXX \
	--with-db-password=XXX_DBPASSWORD_XXX \
	--config-cache \
	--with-archivedir=/nonexistant/path/to/file/archive/dir \
	--sysconfdir=/etc/bacula --with-scriptdir=/etc/bacula/scripts \
	--sharedstatedir=/var/lib/bacula \
	--localstatedir=/var/lib/bacula \
	--with-pid-dir=/var/run/bacula --with-smtp-host=localhost \
	--with-working-dir=/var/lib/bacula \
	--with-subsys-dir=/var/lock


CONF_common	= --disable-gnome --disable-bwx-console --disable-tray-monitor \
			--disable-bat

ifeq ($(DEB_HOST_ARCH_OS),kfreebsd)
CONF_ALL	+= --disable-acl --disable-xattr
endif

CONF_sqlite3	= --with-sqlite3 --without-mysql --without-postgresql --without-sqlite \
			--enable-tray-monitor --enable-bat
CONF_mysql	= --with-mysql --without-sqlite --without-postgresql --without-sqlite3 $(CONF_common)
CONF_pgsql	= --with-postgresql --without-sqlite --without-mysql --without-sqlite3 $(CONF_common)

LONGNAME_sqlite3	= sqlite3
LONGNAME_mysql		= mysql
LONGNAME_pgsql		= postgresql

###########################################################################

# Macro to extract a here document and put it in place
# args: 1 -- db name, 2 -- file to extract, 3 -- version
define ext-upgrade
debian/patches-scripts/extract_here < $(2) > debian/bacula-director-$(1)/$(DBC)/bacula-director-$(1)/upgrade/$(1)/$(3)
endef

# Macro to upgrade db
# args: 1 -- db type
#       2 -- db version path (e.g. 10_to_11)
#       3 -- package version
define ext-upgrade-db
$(call ext-upgrade,$(1),$(BUILDDIR)-$(1)/updatedb/update_$(LONGNAME_$(1))_tables_$(2),$(3))
endef

# Macro to process latest version upgrades for db
# args: 1 -- db type
#       2 -- package version
define ext-upgrade-latest-db
$(call ext-upgrade,$(1),$(BUILDDIR)-$(1)/src/cats/update_$(LONGNAME_$(1))_tables,$(2))
endef

# Macro to extract a here document for install and put it in place
# args: 1 -- db name
define ext-install-db
debian/patches-scripts/extract_here < $(BUILDDIR)-$(1)/src/cats/make_$(LONGNAME_$(1))_tables > debian/bacula-director-$(1)/$(DBC)/bacula-director-$(1)/install/$(1)
endef


build-stamp-%:
	dh_testdir
	mkdir $(BUILDDIR)-$(*)
	tar -cSf - --exclude=./.git --exclude=./debian . | tar -xSpf - -C $(BUILDDIR)-$(*)
	cp /usr/share/misc/config.guess /usr/share/misc/config.sub $(BUILDDIR)-$(*)/autoconf/
	dh_auto_configure -B $(BUILDDIR)-$(*) -- $(CONF_ALL) $(CONF_$(*))
	dh_auto_build -B $(BUILDDIR)-$(*) --parallel
	touch $@

build: build-stamp
build-stamp: $(foreach v,$(VARIANTS),build-stamp-$(v))
	chmod 755 debian/additions/postinst-common
	touch $@

install-stamp: build $(foreach v,$(VARIANTS),install-stamp-$(v))
	touch $@

install-stamp-%: build-stamp-%
	dh install -pbacula-director-$(*) --until dh_auto_install
	mkdir $(INSTALLDIR)-$(*)
	$(MAKE) -C $(BUILDDIR)-$(*) install DESTDIR=$(INSTALLDIR)-$(*)
	dh install -pbacula-director-$(*) --remaining
	touch $@

install-rest: DH-OPTIONS=-a -Nbacula-director-pgsql -Nbacula-director-mysql -Nbacula-director-sqlite3
install-rest:
	dh_prep
	dh_installdirs
	dh_install
	dh_installdocs
	dh_installchangelogs
	dh_installexamples
	dh_installman
	dh_installinit -pbacula-sd -- defaults 90 10
	dh_installinit -pbacula-fd -- defaults 91 9
	dh_installinit --name=bacula-director -pbacula-director-common --no-start -- defaults 92 8
	dh_installdebconf
	dh_installinfo
	dh_installmenu
	dh_bugfiles
	dh_lintian
	dh_usrlocal
	dh_link
	chmod 755 debian/patches-scripts/extract_here
	######### dbconfig-common stuff
	chmod 755 debian/patches-scripts/extract_here
	# Sometimes the latest release doesn't have a copy of the data in updatedb.
	# Manually install those.  CHECK THIS FOR EACH NEW RELEASE, and move older
	# versions to an ext-upgrade-db line.
	#
	# lenny -> squeeze is 10 -> 12
	$(call ext-upgrade-db,$(*),10_to_11,3.0.0)
	$(call ext-upgrade-latest-db,$(*),5.0.0)   # 5.0.0 upgrade 11 to 12
	$(call ext-install-db,$(*))
	touch $@

binary-arch: build install-stamp install-rest

binary-indep:
	dh $@

binary: binary-indep binary-arch
	dh $@ --remaining

clean:
	$(RM) -r $(CURDIR)/debian/tmp-*
	$(RM) *-stamp*
	dh $@

override_dh_shlibdeps:
	# Handle shlibs for the database packages specially so they get
	# the deps on the correct libraries.
	dh_shlibdeps -pbacula-sd-mysql -Lbacula-common-mysql
	dh_shlibdeps -pbacula-director-mysql -Lbacula-common-mysql
	dh_shlibdeps -pbacula-sd-sqlite3 -Lbacula-common-sqlite3
	dh_shlibdeps -pbacula-director-sqlite3 -Lbacula-common-sqlite3
	dh_shlibdeps -pbacula-sd-pgsql -Lbacula-common-pgsql
	dh_shlibdeps -pbacula-director-pgsql -Lbacula-common-pgsql
	# Now build all other shlibdeps.
	dh_shlibdeps -a -Nbacula-sd-mysql -Nbacula-director-mysql \
		-Nbacula-sd-sqlite3 -Nbacula-director-sqlite3 \
		-Nbacula-sd-pgsql -Nbacula-director-pgsql

override_dh_installdocs:
	dh_installdocs -pbacula --link-doc=bacula-common
	dh_installdocs -X.cvsignore -X1 -X*.wml -X*.inc -X*.list -X*.pl -X*.apf -X*.book -Nbacula

override_dh_installchangelogs:
	dh_installchangelogs -Nbacula

override_dh_compress:
	dh_compress -X.pdf

override_dh_auto_configure:
override_dh_auto_build:
override_dh_auto_test:
override_dh_auto_install:

.PHONY: build clean binary-indep binary-arch binary
